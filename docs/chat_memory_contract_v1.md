# Chat + Memory Contract v1 (Stage9.1)

## 1. Цель

Этот документ фиксирует **поведенческий контракт** для слоя `/api/chat` в части работы с локальной памятью (owner_bio, family, work, life, timeline, forget).

Задача: чтобы базовые вопросы про владельца **всегда** отвечались на основе локальной памяти, а не за счёт выдумок модели.

---

## 2. Канонические сценарии (memory-backed chat)

### 2.1. Возраст владельца

- Пример запроса (RU):
  - "Сколько мне лет?"
  - "Напомни, сколько мне сейчас лет."
- Ожидаемый факт:
  - Используется возраст из памяти (тип `bio`, owner="owner", entity="age" или эквивалент).
  - Текущее контрактное значение: **52 года** (Stage5.28 smoke).
- Инварианты:
  - Ответ должен содержать корректный возраст.
  - Допустима свободная формулировка ("Тебе 52 года."), но числовое значение должно быть верным.
  - Источник в логах может быть вида:
    `source: personality_v0+owner_bio_v1+family_v0+work_v0+life_v0+curiosity_v0+facts_timeline_v1+forget_v0`.

### 2.2. Семья (базовый family-profile)

- Примеры запросов:
  - "Как зовут мою жену?"
  - "Напомни, как зовут мою дочь."
- Ожидаемые факты:
  - Жена: имя хранится в `family_v0` / связанных фактах.
  - Дочь: имя хранится в `family_v0` / связанных фактах.
- Инварианты:
  - Имена должны приходить из памяти, а не из фантазии модели.
  - Если факт отсутствует или был явно забыть через `forgetEntity`, ответ должен честно говорить о том, что информации нет.

### 2.3. Базовое место жизни (город / страна)

- Примеры запросов:
  - "Где я живу?"
  - "В какой стране я живу?"
- Ожидаемые факты:
  - Город/страна из `owner_bio_v1` или связанных `bio`-фактов (например, \"Riga\", \"Latvia\").
- Инварианты:
  - Ответ опирается на факты из `facts.ndjson`.
  - При отсутствии факта — честное признание ("я не нашла в памяти, где ты живёшь"), без выдумывания.

### 2.4. Работа / деятельность

- Примеры запросов:
  - "Чем я занимаюсь по жизни?"
  - "Напомни, что для меня главный проект."
- Ожидаемые факты:
  - Описание основной деятельности владельца (строительство, PAiERA Labs и т.п.) из `work_v0` / `life_v0` / `facts_timeline_v1`.
- Инварианты:
  - Ответ должен отражать факты, сохранённые через `saveFacts`.
  - Допускается краткое резюме, но без противоречий сохранённым фактам.

---

## 3. Общие правила для /api/chat + память

1. **Память — первичный источник правды**  
   Для вопросов о владельце (возраст, семья, город, работа, важные события) `/api/chat` обязан сначала опираться на локальную память.

2. **Никаких фантазий по личным фактам**  
   Если факт отсутствует в памяти — ответ должен это честно сказать, а не придумывать значения.

3. **Стабильность канона**  
   Канонические сценарии (возраст, семья, город, работа) рассматриваются как **часть контракта системы**.
   При изменении структуры памяти или логики `memory_manager` мы обязаны убедиться, что эти сценарии продолжают работать.

4. **Связь с selftests**  
   - Smoke-сценарий Stage5.28 ("Сколько мне лет?") уже проверяет базовый контракт возраста.
   - В дальнейшем допускается добавлять отдельные selftest-скрипты для:
     - семьи (жена/дочь),
     - города,
     - основной деятельности.
   - Эти selftests должны использовать `/api/chat` (а не внутренние функции памяти) и проверять, что ответы не расходятся с фактическими данными в `facts.ndjson`.

---

## 4. Обязанности инженера при изменениях

При изменениях в:

- `backend/core/engine_core.js`
- `backend/memory/memory_manager.js`
- `backend/server.js`

которые могут повлиять на ответы `/api/chat` по личным фактам владельца, инженер обязан:

1. Проверить, что канонические сценарии из раздела 2 по-прежнему выдаются корректно (минимум через локальные curl-тесты).
2. При необходимости — добавить/обновить selftest-скрипты, которые:
   - обращаются к `/api/chat`,
   - воспроизводят эти запросы,
   - валидируют ответы.

---

## 5. Связь с памятью (memory invariants)

Этот документ опирается на уже существующие инварианты памяти (Stage7.* и Stage8.*):

- `saveFacts` и `forgetEntity` гарантированно доступны через публичный API.
- Схема `facts.ndjson` стабилизирована и проверяется selftest-скриптами.
- Поверхность вызовов памяти ограничена и задокументирована (`docs/memory_surface_v1.md`).

Любые изменения в памяти, которые нарушают поведение, описанное в этом документе, считаются регрессией и должны либо:

- быть исправлены, либо
- сопровождаться обновлением этого контракта с явным описанием нового поведения.

---

**Stage9.1 статус:**  
Документ `chat_memory_contract_v1.md` создан и зафиксировал канонические сценарии поведения `/api/chat` с опорой на память.
